<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caffis Map Widget</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #root {
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        /* Mapbox overrides for seamless integration */
        .mapboxgl-map {
            font-family: inherit;
        }
        
        .mapboxgl-canvas {
            outline: none;
        }
        
        .mapboxgl-control-container {
            position: absolute;
        }
        
        /* Custom loading animation */
        .loading-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 9999;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        
        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }
    </style>
</head>
<body>
    <!-- Loading screen -->
    <div id="loading" class="loading-container">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2>Caffis Map</h2>
            <p>Loading interactive map experience...</p>
        </div>
    </div>
    
    <!-- React app container -->
    <div id="root"></div>
    
    <!-- Load dependencies in order -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    
    <script>
        console.log('üó∫Ô∏è Caffis Map Widget - Starting...');
        
        // Global configuration
        window.CAFFIS_MAP_CONFIG = {
            version: '1.0.0',
            environment: 'development',
            apiUrl: 'http://localhost:5001',
            socketUrl: 'http://localhost:5001'
        };
        
        // Extract URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const isEmbedded = urlParams.get('embed') === 'true';
        const token = urlParams.get('token');
        const theme = urlParams.get('theme') || 'light';
        
        console.log('üìä Mode:', isEmbedded ? 'Embedded' : 'Standalone');
        console.log('üé® Theme:', theme);
        if (token) console.log('üîë Token received:', token.substring(0, 20) + '...');
        
        // Enhanced dependency checking
        function checkDependencies() {
            const status = document.getElementById('status');
            
            console.log('üîç Checking dependencies...');
            
            // Check React
            if (typeof React === 'undefined') {
                console.error('‚ùå React not loaded');
                return false;
            }
            console.log('‚úÖ React loaded');
            
            // Check ReactDOM
            if (typeof ReactDOM === 'undefined') {
                console.error('‚ùå ReactDOM not loaded');
                return false;
            }
            console.log('‚úÖ ReactDOM loaded');
            
            // Check Mapbox
            if (typeof mapboxgl === 'undefined') {
                console.error('‚ùå Mapbox GL not loaded');
                return false;
            }
            console.log('‚úÖ Mapbox GL loaded');
            
            return true;
        }
        
        // Load and initialize widget
        function initializeWidget() {
            if (!checkDependencies()) {
                setTimeout(initializeWidget, 100);
                return;
            }
            
            console.log('üöÄ Initializing widget...');
            
            // Hide loading screen
            const loading = document.getElementById('loading');
            if (loading) {
                loading.classList.add('fade-out');
                setTimeout(() => loading.remove(), 500);
            }
            
            // Load the widget script
            const script = document.createElement('script');
            script.src = '/caffis-map-widget.js';
            script.onload = () => {
                console.log('üì¶ Widget script loaded');
                renderWidget();
            };
            script.onerror = () => {
                console.error('‚ùå Failed to load widget script');
                showError('Failed to load map widget');
            };
            
            document.head.appendChild(script);
        }
        
        // Render the widget
        // Render the widget
        function renderWidget() {
            console.log('üé® Rendering widget...');
            
            try {
                const container = document.getElementById('root');
                const root = ReactDOM.createRoot(container);
                
                // Check multiple ways the widget might be available
                let MapWidget = null;
                
                if (window.SimpleMapWidget) {
                    console.log('‚úÖ Found SimpleMapWidget directly');
                    MapWidget = window.SimpleMapWidget;
                } else if (window.CaffisMapWidget && window.CaffisMapWidget.SimpleMapWidget) {
                    console.log('‚úÖ Found SimpleMapWidget in CaffisMapWidget');
                    MapWidget = window.CaffisMapWidget.SimpleMapWidget;
                } else if (window.CaffisMapWidget && window.CaffisMapWidget.DraggableMapWidget) {
                    console.log('‚úÖ Found DraggableMapWidget in CaffisMapWidget');
                    MapWidget = window.CaffisMapWidget.DraggableMapWidget;
                }
                
                if (MapWidget) {
                    console.log('üéØ Creating React element with widget');
                    
                    root.render(
                        React.createElement(MapWidget, {
                            token: token,
                            theme: theme,
                            embedded: isEmbedded,
                            onLoad: () => console.log('‚úÖ Widget rendered successfully'),
                            onError: (error) => console.error('‚ùå Widget error:', error)
                        })
                    );
                    
                    console.log('üéâ Map widget initialized successfully!');
                } else {
                    console.error('‚ùå No widget found. Available:', {
                        window_CaffisMapWidget: typeof window.CaffisMapWidget,
                        window_SimpleMapWidget: typeof window.SimpleMapWidget,
                        CaffisMapWidget_keys: window.CaffisMapWidget ? Object.keys(window.CaffisMapWidget) : 'undefined'
                    });
                    throw new Error('Widget not found in any expected location');
                }
                
            } catch (error) {
                console.error('‚ùå Error rendering widget:', error);
                showError('Error initializing map: ' + error.message);
            }
        }
        
        // Show error state
        function showError(message) {
            const container = document.getElementById('root');
            container.innerHTML = `
                <div style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    text-align: center;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                ">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                    <h3 style="color: #e74c3c; margin-bottom: 8px;">Map Service Error</h3>
                    <p style="color: #666; margin-bottom: 16px;">${message}</p>
                    <button onclick="window.location.reload()" style="
                        padding: 12px 24px;
                        background: #e74c3c;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                    ">
                        üîÑ Retry
                    </button>
                </div>
            `;
        }
        
        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('üö® Global error:', event.error);
            if (event.error && event.error.message && event.error.message.includes('mapbox')) {
                showError('Mapbox token error - please check configuration');
            }
        });
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeWidget);
        } else {
            initializeWidget();
        }
        
        console.log('üìã Caffis Map Widget initialized');
    </script>
</body>
</html>