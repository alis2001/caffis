# ğŸ“‹ Caffis Platform - Architettura Completa

## ğŸ—ï¸ OVERVIEW GENERALE

### Struttura Microservizi
```
Caffis Platform
â”œâ”€â”€ Main App (caffis-main-app/)
â”‚   â”œâ”€â”€ Client (Next.js + React) â†’ Porto 3000
â”‚   â””â”€â”€ Server (Node.js + Express + PostgreSQL) â†’ Porto 5000
â”œâ”€â”€ Map Service (caffis-map-service/)
â”‚   â”œâ”€â”€ Backend (Node.js + Socket.IO + Redis) â†’ Porto 5001  
â”‚   â””â”€â”€ Frontend (React Components Widget)
â”œâ”€â”€ Chat Service (caffis-chat-service/) â†’ Porto 5002 [FUTURO]
â”œâ”€â”€ Notification Service (caffis-notification-service/) â†’ Porto 5003 [FUTURO]
â””â”€â”€ Shared Infrastructure
    â”œâ”€â”€ PostgreSQL Database â†’ Porto 5432
    â”œâ”€â”€ Redis Cache â†’ Porto 6379
    â””â”€â”€ Nginx Load Balancer â†’ Porto 80
```

---

## ğŸ—ºï¸ MAP SERVICE - DETTAGLIO ARCHITETTURALE

### PerchÃ© Backend + Frontend separati?

#### MAP BACKEND (Node.js Microservice)
**ResponsabilitÃ :**
- âœ… **Geolocalizzazione real-time** via Socket.IO
- âœ… **Cache Redis** per location data e performance
- âœ… **Business Logic** per matching utenti nelle vicinanze
- âœ… **API REST** per operazioni CRUD mappa
- âœ… **Authentication** JWT validation
- âœ… **Broadcast Events** real-time a utenti connessi

**Tech Stack:**
- Node.js + Express
- Socket.IO per WebSocket
- Redis per caching
- JWT per auth
- Geolib per calcoli geografici

#### MAP FRONTEND (React Widget)
**ResponsabilitÃ :**
- âœ… **UI Widget** draggable/resizable sulla dashboard
- âœ… **Mapbox GL** integration per rendering mappa
- âœ… **Socket.IO Client** per real-time updates
- âœ… **User Interactions** (click markers, send invites)
- âœ… **State Management** per posizioni utenti
- âœ… **Responsive Design** mobile-ready

**Tech Stack:**
- React Components
- Mapbox GL JS
- Socket.IO Client
- Framer Motion per animazioni
- CSS Modules

---

## ğŸ”„ COMMUNICATION FLOW

### Real-time Data Flow
```
1. User Dashboard â†’ Click "Pronto a Connettersi!"
2. Map Widget â†’ Requests GPS permission
3. Frontend â†’ WebSocket connect to Map Service :5001
4. Map Backend â†’ Validates JWT + stores location in Redis
5. Redis â†’ Caches location with TTL (5 min)
6. Socket.IO â†’ Broadcasts to users in same city
7. Other Users â†’ Receive real-time position updates
8. Mapbox â†’ Renders markers with live positions
9. User Clicks Marker â†’ Profile popup with invite actions
10. Invite Sent â†’ Socket.IO delivers to target user
```

### API Communication
```
Main App Frontend â†â†’ Main App Backend (REST)
Map Widget â†â†’ Map Service Backend (Socket.IO + REST)
Map Service â†â†’ Redis Cache (location data)
Map Service â†â†’ Main App Backend (user profiles via REST)
```

---

## ğŸ“ DIRECTORY STRUCTURE

### Root Project Structure
```
caffis-platform/
â”œâ”€â”€ docker-compose.yml                 # Orchestrazione completa
â”œâ”€â”€ .env.global                       # Variabili globali
â”œâ”€â”€ nginx/                            # Load Balancer
â”‚   â”œâ”€â”€ nginx.conf
â”‚   â””â”€â”€ ssl/
â”œâ”€â”€ caffis-main-app/                  # App Principale (ESISTENTE)
â”‚   â”œâ”€â”€ client/                       # Frontend Next.js
â”‚   â”œâ”€â”€ server/                       # Backend Node.js
â”‚   â””â”€â”€ docker-compose.yml
â”œâ”€â”€ caffis-map-service/               # Microservizio Mappa (NUOVO)
â”‚   â”œâ”€â”€ backend/                      # Map Backend
â”‚   â”œâ”€â”€ frontend/                     # Map Widget Components
â”‚   â”œâ”€â”€ nginx/                        # Static assets server
â”‚   â”œâ”€â”€ redis/                        # Redis config
â”‚   â””â”€â”€ docker-compose.yml
â”œâ”€â”€ caffis-chat-service/              # Chat Service (FUTURO)
â””â”€â”€ caffis-notification-service/      # Notifications (FUTURO)
```

### Map Service Structure Dettagliata
```
caffis-map-service/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ controllers/              # API endpoints
â”‚   â”‚   â”‚   â”œâ”€â”€ mapController.js
â”‚   â”‚   â”‚   â””â”€â”€ locationController.js
â”‚   â”‚   â”œâ”€â”€ services/                 # Business logic
â”‚   â”‚   â”‚   â”œâ”€â”€ redisService.js
â”‚   â”‚   â”‚   â”œâ”€â”€ socketService.js
â”‚   â”‚   â”‚   â”œâ”€â”€ locationService.js
â”‚   â”‚   â”‚   â””â”€â”€ geoService.js
â”‚   â”‚   â”œâ”€â”€ middleware/               # Auth, validation, etc.
â”‚   â”‚   â”‚   â”œâ”€â”€ authMiddleware.js
â”‚   â”‚   â”‚   â””â”€â”€ rateLimitMiddleware.js
â”‚   â”‚   â”œâ”€â”€ routes/                   # Route definitions
â”‚   â”‚   â”‚   â”œâ”€â”€ mapRoutes.js
â”‚   â”‚   â”‚   â””â”€â”€ healthRoutes.js
â”‚   â”‚   â”œâ”€â”€ utils/                    # Utilities
â”‚   â”‚   â”‚   â”œâ”€â”€ logger.js
â”‚   â”‚   â”‚   â””â”€â”€ geoUtils.js
â”‚   â”‚   â””â”€â”€ config/                   # Configuration
â”‚   â”‚       â””â”€â”€ database.js
â”‚   â”œâ”€â”€ tests/                        # Test files
â”‚   â”œâ”€â”€ Dockerfile                    # Docker backend
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ server.js                     # Entry point
â”‚   â””â”€â”€ .env.example
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ components/                   # React Components
â”‚   â”‚   â”œâ”€â”€ DraggableMapWidget.jsx    # Main widget
â”‚   â”‚   â”œâ”€â”€ MapboxMap.jsx            # Mapbox integration
â”‚   â”‚   â”œâ”€â”€ UserMarker.jsx           # User markers
â”‚   â”‚   â”œâ”€â”€ UserProfilePopup.jsx     # Profile modals
â”‚   â”‚   â””â”€â”€ AvailabilityToggle.jsx   # Status toggle
â”‚   â”œâ”€â”€ hooks/                        # Custom React hooks
â”‚   â”‚   â”œâ”€â”€ useMapSocket.js          # Socket.IO hook
â”‚   â”‚   â”œâ”€â”€ useGeolocation.js        # GPS hook
â”‚   â”‚   â””â”€â”€ useMapbox.js             # Mapbox hook
â”‚   â”œâ”€â”€ services/                     # API services
â”‚   â”‚   â”œâ”€â”€ mapApi.js                # REST API calls
â”‚   â”‚   â””â”€â”€ socketClient.js          # Socket client
â”‚   â”œâ”€â”€ styles/                       # CSS styles
â”‚   â”‚   â”œâ”€â”€ map-widget.css
â”‚   â”‚   â””â”€â”€ mapbox-custom.css
â”‚   â”œâ”€â”€ utils/                        # Utilities
â”‚   â”‚   â””â”€â”€ coordinates.js
â”‚   â”œâ”€â”€ Dockerfile                    # Docker frontend
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ webpack.config.js
â”‚   â””â”€â”€ index.js                      # Export entry
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ nginx.conf                    # Static server config
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ redis/
â”‚   â””â”€â”€ redis.conf                    # Redis configuration
â”œâ”€â”€ docker-compose.yml               # Map service orchestration
â”œâ”€â”€ Makefile                          # Development commands
â””â”€â”€ README.md
```

---

## ğŸ³ DOCKER ARCHITECTURE

### Container Strategy
```
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚                  DOCKER COMPOSE STACK                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ MAIN APP    â”‚  â”‚ MAP SERVICE â”‚  â”‚   NGINX     â”‚    â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚ Load Balancerâ”‚    â”‚
â”‚  â”‚ Frontend    â”‚  â”‚ Backend     â”‚  â”‚             â”‚    â”‚
â”‚  â”‚ :3000       â”‚  â”‚ :5001       â”‚  â”‚ :80         â”‚    â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚    â”‚
â”‚  â”‚ Backend     â”‚  â”‚ Frontend    â”‚  â”‚             â”‚    â”‚
â”‚  â”‚ :5000       â”‚  â”‚ Components  â”‚  â”‚             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                 â”‚               â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                           â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ POSTGRESQL  â”‚  â”‚    REDIS    â”‚  â”‚   MONGODB   â”‚    â”‚
â”‚  â”‚ Main DB     â”‚  â”‚ Map Cache   â”‚  â”‚ Chat DB     â”‚    â”‚
â”‚  â”‚ :5432       â”‚  â”‚ :6379       â”‚  â”‚ :27017      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
```

### Network Isolation
```
Networks:
â”œâ”€â”€ frontend-network (public access)
â”‚   â”œâ”€â”€ Nginx Load Balancer
â”‚   â”œâ”€â”€ Main App Frontend
â”‚   â””â”€â”€ Map Service Frontend
â”œâ”€â”€ backend-network (internal only)
â”‚   â”œâ”€â”€ Main App Backend
â”‚   â”œâ”€â”€ Map Service Backend
â”‚   â””â”€â”€ Chat Service Backend
â””â”€â”€ database-network (internal only)
    â”œâ”€â”€ PostgreSQL
    â”œâ”€â”€ Redis
    â””â”€â”€ MongoDB
```

---

## ğŸ” SECURITY ARCHITECTURE

### Authentication Flow
```
1. User Login â†’ Main App Backend
2. JWT Token Generated â†’ Stored in Frontend
3. Map Widget Request â†’ Includes JWT in header
4. Map Service â†’ Validates JWT with same secret
5. WebSocket Connection â†’ JWT in handshake auth
6. Real-time Communication â†’ Authorized user only
```

### Security Layers
- âœ… **JWT Authentication** shared between services
- âœ… **Rate Limiting** per API endpoint
- âœ… **CORS Protection** configured per service
- âœ… **Helmet Security Headers** 
- âœ… **Input Validation** with Joi schemas
- âœ… **Network Isolation** via Docker networks
- âœ… **HTTPS Termination** at Nginx level

---

## ğŸ“Š DATA FLOW & CACHING

### Redis Caching Strategy
```
Keys Structure:
â”œâ”€â”€ location:{userId}           # User location (TTL: 5min)
â”œâ”€â”€ city:{cityName}            # Users in city (TTL: 5min)  
â”œâ”€â”€ coffee_shops:{cityName}    # Coffee shops (TTL: 1hr)
â””â”€â”€ user_profile:{userId}      # User profiles (TTL: 30min)
```

### Database Distribution
```
PostgreSQL (Main App):
â”œâ”€â”€ Users & Authentication
â”œâ”€â”€ User Preferences & Onboarding
â”œâ”€â”€ Coffee Invites & Events
â””â”€â”€ User Relationships

Redis (Map Service):
â”œâ”€â”€ Real-time Locations
â”œâ”€â”€ Active User Sessions
â”œâ”€â”€ City-based User Groups
â””â”€â”€ Coffee Shop Data Cache

MongoDB (Chat Service - Future):
â”œâ”€â”€ Messages & Conversations
â”œâ”€â”€ Message Attachments
â””â”€â”€ Chat Room Metadata
```

---

## ğŸš€ DEPLOYMENT STRATEGY

### Development Environment
```bash
# Start individual services
docker-compose up main-app-backend postgres
docker-compose up map-service redis  
docker-compose up chat-service mongo

# Start entire platform
docker-compose up --build
```

### Production Environment
```bash
# Scaled deployment
docker-compose up --scale map-service-backend=3
docker-compose up --scale chat-service-backend=2

# With monitoring
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

### CI/CD Pipeline
```
1. Git Push â†’ GitHub/GitLab
2. Automated Tests â†’ Jest + Supertest
3. Docker Build â†’ Multi-stage builds
4. Image Push â†’ Docker Registry
5. Deploy â†’ Kubernetes/Docker Swarm
6. Health Checks â†’ Service monitoring
7. Rollback â†’ If health checks fail
```

---

## ğŸ“ˆ SCALABILITY DESIGN

### Horizontal Scaling Points
- âœ… **Map Service Backend** â†’ Multiple instances behind load balancer
- âœ… **Chat Service** â†’ Stateless with Redis session store
- âœ… **Database Read Replicas** â†’ For read-heavy operations
- âœ… **Redis Clustering** â†’ For high-availability caching
- âœ… **CDN Integration** â†’ For static assets and map tiles

### Performance Optimizations
- âœ… **Connection Pooling** for database connections
- âœ… **Redis Pipeline** for batch operations
- âœ… **WebSocket Connection Reuse** 
- âœ… **Gzip Compression** for API responses
- âœ… **Map Tile Caching** for Mapbox optimization

---

## ğŸ”§ DEVELOPMENT WORKFLOW

### Local Development Setup
```
1. Clone repo
2. Copy .env files
3. docker-compose up postgres redis
4. npm run dev (each service)
5. Hot reload enabled
```

### Testing Strategy
```
â”œâ”€â”€ Unit Tests â†’ Jest + React Testing Library
â”œâ”€â”€ Integration Tests â†’ Supertest + Socket.IO testing
â”œâ”€â”€ E2E Tests â†’ Cypress for user flows
â””â”€â”€ Load Tests â†’ Artillery for WebSocket performance
```

### Monitoring & Observability
```
â”œâ”€â”€ Health Checks â†’ /health endpoints
â”œâ”€â”€ Metrics â†’ Prometheus + Grafana
â”œâ”€â”€ Logging â†’ Winston + ELK Stack
â”œâ”€â”€ Error Tracking â†’ Sentry integration
â””â”€â”€ Performance â†’ APM monitoring
```

---

## ğŸ“± MOBILE STRATEGY

### Progressive Web App (PWA)
- âœ… **Service Worker** for offline functionality
- âœ… **Web Manifest** for mobile installation
- âœ… **Push Notifications** for coffee invites
- âœ… **Geolocation API** for accurate positioning
- âœ… **Touch Gestures** for map interactions

### Future Native App Integration
- âœ… **React Native** for mobile apps
- âœ… **Shared API Layer** across web and mobile
- âœ… **WebSocket Reuse** for real-time features
- âœ… **Offline-first** data synchronization

---

## ğŸ¯ ROADMAP & FUTURE FEATURES

### Phase 1 (Current) - Core Map Functionality
- âœ… Real-time user locations
- âœ… Coffee shop markers
- âœ… User profile popups
- âœ… Basic invite system

### Phase 2 - Enhanced Social Features
- ğŸ”„ Real-time chat integration
- ğŸ”„ Advanced user matching algorithms
- ğŸ”„ Coffee shop ratings & reviews
- ğŸ”„ Group meetup organization

### Phase 3 - Advanced Features
- ğŸ”„ AI-powered recommendations
- ğŸ”„ Loyalty program integration
- ğŸ”„ Payment system for coffee shops
- ğŸ”„ Advanced analytics dashboard

### Phase 4 - Scale & Performance
- ğŸ”„ Multi-city expansion
- ğŸ”„ Kubernetes orchestration
- ğŸ”„ Global CDN deployment
- ğŸ”„ Advanced monitoring & alerting

---

## ğŸ’¡ KEY DESIGN DECISIONS

### Why Microservices?
1. **Independent Scaling** â†’ Map service can scale separately
2. **Technology Diversity** â†’ Best tool for each job
3. **Team Autonomy** â†’ Different teams can work independently  
4. **Fault Isolation** â†’ Map failure doesn't break main app
5. **Deployment Flexibility** â†’ Deploy services independently

### Why Redis for Map Data?
1. **Speed** â†’ Sub-millisecond response times
2. **TTL Support** â†’ Automatic cleanup of stale locations
3. **Pub/Sub** â†’ Real-time broadcasting capabilities
4. **Geospatial Commands** â†’ Built-in geographic operations
5. **High Availability** â†’ Clustering and persistence options

### Why Socket.IO for Real-time?
1. **Browser Compatibility** â†’ WebSocket with fallbacks
2. **Room Management** â†’ Easy city-based grouping
3. **Event-based** â†’ Clean separation of concerns
4. **Reconnection Logic** â†’ Automatic reconnection handling
5. **Scaling Support** â†’ Redis adapter for multiple instances

---

Questa architettura garantisce:
âœ… **ScalabilitÃ ** â†’ Ogni servizio scala indipendentemente
âœ… **ManutenibilitÃ ** â†’ Codice modulare e ben organizzato
âœ… **Performance** â†’ Cache intelligente e real-time ottimizzato
âœ… **Sicurezza** â†’ Autenticazione distribuita e network isolation
âœ… **Developer Experience** â†’ Hot reload e easy debugging
âœ… **Production Ready** â†’ Monitoring, logging, health checks